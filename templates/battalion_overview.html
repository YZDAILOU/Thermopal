<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Battalion Overview - ThermoPal</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Battalion Overview</h1>
            <h2 class="text-xl text-gray-600 mb-2">{{ battalion.name }}</h2>
            <p class="text-gray-500">Headquarters Dashboard - Company Conduct Management</p>
        </div>

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="mb-6">
                    {% for category, message in messages %}
                        <div class="p-4 mb-4 rounded-md {% if category == 'error' %}bg-red-50 text-red-700 border border-red-200{% elif category == 'success' %}bg-green-50 text-green-700 border border-green-200{% else %}bg-blue-50 text-blue-700 border border-blue-200{% endif %}">
                            {{ message }}
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <!-- Action Bar -->
        <div class="flex flex-col sm:flex-row justify-between items-center mb-6 space-y-4 sm:space-y-0">
            <div class="flex space-x-4">
                <a href="{{ url_for('create_conduct_new') }}" 
                   class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 transition-colors font-medium flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    Create New Conduct
                </a>
                <button onclick="toggleDeleteMode()" id="delete-mode-btn"
                        class="bg-red-600 text-white px-6 py-2 rounded-md hover:bg-red-700 transition-colors font-medium flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                    Delete Conducts
                </button>
            </div>
            <div class="flex items-center space-x-4">
                <!-- Delete Controls (Initially Hidden) -->
                <div id="delete-controls" class="hidden flex items-center space-x-2">
                    <button onclick="selectAllConducts()" class="text-sm text-blue-600 hover:text-blue-800">Select All</button>
                    <button onclick="deselectAllConducts()" class="text-sm text-gray-600 hover:text-gray-800">Deselect All</button>
                    <button onclick="confirmDelete()" id="confirm-delete-btn" 
                            class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 transition-colors text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed" 
                            disabled>
                        Delete Selected
                    </button>
                    <button onclick="cancelDeleteMode()" 
                            class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 transition-colors text-sm font-medium">
                        Cancel
                    </button>
                </div>
                <a href="{{ url_for('index') }}" 
                   class="text-gray-600 hover:text-gray-800 flex items-center">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                    </svg>
                    Back to Home
                </a>
            </div>
        </div>

        <!-- Summary Statistics -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex items-center">
                    <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                        <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        </svg>
                    </div>
                    <div class="ml-4">
                        <p class="text-2xl font-bold text-gray-800">{{ company_data|length }}</p>
                        <p class="text-gray-600">Companies</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex items-center">
                    <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                        <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                        </svg>
                    </div>
                    <div class="ml-4">
                        <p class="text-2xl font-bold text-gray-800">{{ total_conducts }}</p>
                        <p class="text-gray-600">Total Conducts</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex items-center">
                    <div class="w-12 h-12 bg-yellow-100 rounded-full flex items-center justify-center">
                        <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                    </div>
                    <div class="ml-4">
                        <p class="text-2xl font-bold text-gray-800">{{ active_conducts }}</p>
                        <p class="text-gray-600">Active Conducts</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Companies Overview -->
        {% if company_data %}
            <form id="delete-form" action="{{ url_for('delete_conducts', battalion_id=battalion.id) }}" method="POST">
                <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-800">Companies (Alphabetical Order)</h3>
                        <div id="delete-mode-notice" class="hidden mt-2">
                            <p class="text-sm text-red-600 font-medium">üóëÔ∏è Delete Mode Active - Select conducts to delete</p>
                        </div>
                    </div>
                
                <div class="divide-y divide-gray-200">
                    {% for company in company_data %}
                        <div class="px-6 py-4 hover:bg-gray-50 transition-colors cursor-pointer" 
                             onclick="toggleCompanyDetails('company-{{ company.id }}')">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-4">
                                    <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                                        <span class="text-blue-600 font-semibold">{{ company.name[0].upper() }}</span>
                                    </div>
                                    <div>
                                        <h4 class="text-lg font-medium text-gray-800">{{ company.name }}</h4>
                                        <p class="text-sm text-gray-600">Created: {{ company.created_at.strftime('%Y-%m-%d') }}</p>
                                    </div>
                                </div>
                                
                                <div class="flex items-center space-x-6">
                                    <div class="text-center">
                                        <p class="text-lg font-semibold text-gray-800">{{ company.conducts|length }}</p>
                                        <p class="text-sm text-gray-600">Total</p>
                                    </div>
                                    <div class="text-center">
                                        <p class="text-lg font-semibold text-green-600">{{ company.conducts|selectattr("status", "equalto", "active")|list|length }}</p>
                                        <p class="text-sm text-gray-600">Active</p>
                                    </div>
                                    <div class="flex space-x-2">
                                        <a href="{{ url_for('company_conducts', company_id=company.id) }}" 
                                           class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors text-sm font-medium"
                                           onclick="event.stopPropagation()">
                                            View Conducts
                                        </a>
                                    </div>
                                    <svg class="w-5 h-5 text-gray-400 transform transition-transform company-arrow" 
                                         fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </div>
                            </div>
                            
                            <!-- Expandable Company Details -->
                            <div id="company-{{ company.id }}" class="hidden mt-4 pl-14">
                                <div class="bg-gray-50 rounded-lg p-4">
                                    <h5 class="font-medium text-gray-800 mb-2">
                                        All Conducts for {{ company.name }}
                                        <span class="text-sm text-gray-500 font-normal">({{ company.conducts|length }} total)</span>
                                    </h5>
                                    {% if company.conducts %}
                                        <div class="space-y-2 max-h-64 overflow-y-auto">
                                            {% for conduct in company.conducts %}
                                                <div class="flex justify-between items-center text-sm bg-white p-3 rounded border">
                                                    <div class="flex items-center space-x-3">
                                                        <!-- Checkbox for delete mode -->
                                                        <input type="checkbox" name="conduct_ids" value="{{ conduct.id }}" 
                                                               class="conduct-checkbox hidden w-4 h-4 text-red-600 border-gray-300 rounded focus:ring-red-500"
                                                               onchange="updateDeleteButton()">
                                                        <div>
                                                            <span class="text-gray-800 font-medium">{{ conduct.name }}</span>
                                                            <div class="text-xs text-gray-500 mt-1">
                                                                Created: {{ conduct.created_at.strftime('%Y-%m-%d %H:%M') }}
                                                                {% if conduct.users %}
                                                                    | {{ conduct.users|length }} participants
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="flex items-center space-x-2">
                                                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium 
                                                                     {% if conduct.status == 'active' %}bg-green-100 text-green-800{% else %}bg-gray-100 text-gray-800{% endif %}">
                                                            {{ conduct.status.title() }}
                                                        </span>
                                                        <span class="text-gray-500 text-xs">PIN: {{ conduct.pin }}</span>
                                                    </div>
                                                </div>
                                            {% endfor %}
                                        </div>
                                    {% else %}
                                        <p class="text-sm text-gray-500">No conducts yet</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
            </form>
        {% else %}
            <!-- Empty State -->
            <div class="text-center py-12">
                <svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                </svg>
                <h3 class="text-lg font-medium text-gray-900 mb-2">No companies found</h3>
                <p class="text-gray-500 mb-6">This battalion hasn't created any companies yet.</p>
                <a href="{{ url_for('create_conduct_new') }}" 
                   class="inline-block bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 transition-colors font-medium">
                    Create First Company Conduct
                </a>
            </div>
        {% endif %}
    </div>

    <script>
        let isDeleteMode = false;
        
        function toggleCompanyDetails(companyId) {
            const details = document.getElementById(companyId);
            const arrow = details.previousElementSibling.querySelector('.company-arrow');
            
            if (details.classList.contains('hidden')) {
                details.classList.remove('hidden');
                arrow.style.transform = 'rotate(180deg)';
            } else {
                details.classList.add('hidden');
                arrow.style.transform = 'rotate(0deg)';
            }
        }
        
        function toggleDeleteMode() {
            isDeleteMode = !isDeleteMode;
            const deleteControls = document.getElementById('delete-controls');
            const deleteModeBtn = document.getElementById('delete-mode-btn');
            const deleteModeNotice = document.getElementById('delete-mode-notice');
            const checkboxes = document.querySelectorAll('.conduct-checkbox');
            
            if (isDeleteMode) {
                // Enter delete mode
                deleteControls.classList.remove('hidden');
                deleteModeBtn.textContent = 'Exit Delete Mode';
                deleteModeBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                deleteModeBtn.classList.add('bg-gray-600', 'hover:bg-gray-700');
                deleteModeNotice.classList.remove('hidden');
                
                // Show all checkboxes
                checkboxes.forEach(checkbox => {
                    checkbox.classList.remove('hidden');
                });
                
                // Auto-expand all companies to show conducts
                const companyDetails = document.querySelectorAll('[id^="company-"]');
                companyDetails.forEach(details => {
                    if (details.classList.contains('hidden')) {
                        const companyId = details.id;
                        toggleCompanyDetails(companyId);
                    }
                });
            } else {
                // Exit delete mode
                cancelDeleteMode();
            }
        }
        
        function cancelDeleteMode() {
            isDeleteMode = false;
            const deleteControls = document.getElementById('delete-controls');
            const deleteModeBtn = document.getElementById('delete-mode-btn');
            const deleteModeNotice = document.getElementById('delete-mode-notice');
            const checkboxes = document.querySelectorAll('.conduct-checkbox');
            
            deleteControls.classList.add('hidden');
            deleteModeBtn.textContent = 'Delete Conducts';
            deleteModeBtn.classList.remove('bg-gray-600', 'hover:bg-gray-700');
            deleteModeBtn.classList.add('bg-red-600', 'hover:bg-red-700');
            deleteModeNotice.classList.add('hidden');
            
            // Hide all checkboxes and uncheck them
            checkboxes.forEach(checkbox => {
                checkbox.classList.add('hidden');
                checkbox.checked = false;
            });
            
            updateDeleteButton();
        }
        
        function selectAllConducts() {
            const checkboxes = document.querySelectorAll('.conduct-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
            });
            updateDeleteButton();
        }
        
        function deselectAllConducts() {
            const checkboxes = document.querySelectorAll('.conduct-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            updateDeleteButton();
        }
        
        function updateDeleteButton() {
            const checkedBoxes = document.querySelectorAll('.conduct-checkbox:checked');
            const deleteBtn = document.getElementById('confirm-delete-btn');
            
            if (checkedBoxes.length > 0) {
                deleteBtn.disabled = false;
                deleteBtn.textContent = `Delete Selected (${checkedBoxes.length})`;
            } else {
                deleteBtn.disabled = true;
                deleteBtn.textContent = 'Delete Selected';
            }
        }
        
        function confirmDelete() {
            const checkedBoxes = document.querySelectorAll('.conduct-checkbox:checked');
            
            if (checkedBoxes.length === 0) {
                alert('Please select at least one conduct to delete.');
                return;
            }
            
            // Get conduct names for confirmation
            const conductNames = Array.from(checkedBoxes).map(checkbox => {
                const conductRow = checkbox.closest('.flex');
                const conductName = conductRow.querySelector('.text-gray-800').textContent;
                return conductName;
            });
            
            const confirmMessage = `Are you sure you want to delete ${checkedBoxes.length} conduct(s)?\n\nThis will permanently delete:\n${conductNames.map(name => `‚Ä¢ ${name}`).join('\n')}\n\nThis action cannot be undone.`;
            
            if (confirm(confirmMessage)) {
                document.getElementById('delete-form').submit();
            }
        }
        
        // Initialize delete button state on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateDeleteButton();
        });
    </script>
</body>
</html>